// Prisma Schema for Ayn Platform
generator client {
  provider        = "prisma-client-py"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector]
}

// User Model
model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  password      String
  role          Role?
  institutionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  evidence      Evidence[] @relation("EvidenceUploader")
  notifications Notification[]
  chats         Chat[]
  activities    Activity[]

  // Platform State Relations
  platformFiles    PlatformFile[]
  platformEvidence PlatformEvidence[]
  platformGaps     PlatformGap[]
  platformMetrics  PlatformMetric[]
  platformEvents   PlatformEvent[]

  @@index([email])
  @@index([institutionId])
}

enum Role {
  ADMIN
  TEACHER
  AUDITOR
  STUDENT
  UNIVERSITY
  INSTITUTION
  OTHER
}

// Institution Model
model Institution {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users                 User[]
  institutionStandards  InstitutionStandard[]
  gapAnalyses           GapAnalysis[]

  @@index([name])
}

// Institution–Standard link (many-to-many)
model InstitutionStandard {
  id            String   @id @default(uuid())
  institutionId String
  standardId    String
  createdAt     DateTime @default(now())

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  standard    Standard   @relation(fields: [standardId], references: [id], onDelete: Cascade)

  @@unique([institutionId, standardId])
  @@index([institutionId])
  @@index([standardId])
}

// Standard Model
model Standard {
  id             String   @id @default(uuid())
  title          String
  code           String?
  category       String?
  description    String?
  region         String?
  icon           String?  @default("GraduationCap")
  color          String?  @default("from-blue-600 to-indigo-600")
  features       String[] @default([])
  isPublic       Boolean  @default(true)
  source         String?  // "seeded" or "imported-pdf"
  estimatedSetup String?

  criteria     Criterion[]
  institutionStandards InstitutionStandard[]
  gapAnalyses  GapAnalysis[]

  @@index([title])
}

// Criterion Model
model Criterion {
  id          String   @id @default(uuid())
  standardId  String
  title       String
  description String?

  standard    Standard @relation(fields: [standardId], references: [id], onDelete: Cascade)
  evidence    Evidence[] // Deprecated single link
  evidenceCriteria EvidenceCriterion[] // New many-to-many link
  criteriaMappings CriteriaMapping[] // Detailed AI mapping results

  @@index([standardId])
}

// Evidence Model
model Evidence {
  id              String   @id @default(uuid())
  fileUrl         String
  originalFilename String? // Storing original name as required
  uploadedById    String
  ownerId         String?   // Organization/Institution identifier for multi-tenancy
  
  // AI Analysis Data
  title           String?
  summary         String?  @db.Text
  documentType    String?
  confidenceScore Float?   @default(0.0)
  status          String   @default("processing") // processing, analyzed, failed, unmapped
  
  // Relations
  uploadedBy      User     @relation("EvidenceUploader", fields: [uploadedById], references: [id], onDelete: Cascade)
  criteria        EvidenceCriterion[]
  criteriaMappings CriteriaMapping[]

  // Deprecated single link (keeping for safety until migration complete)
  criterionId     String?
  criterion       Criterion? @relation(fields: [criterionId], references: [id], onDelete: SetNull)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([uploadedById])
  @@index([ownerId])
  @@index([status])
}

// Many-to-Many Link between Evidence and Criteria
model EvidenceCriterion {
  id          String    @id @default(uuid())
  evidenceId  String
  criterionId String
  
  evidence    Evidence  @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  criterion   Criterion @relation(fields: [criterionId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())

  @@unique([evidenceId, criterionId])
  @@index([evidenceId])
  @@index([criterionId])
}

// Detailed AI Criteria Mapping
model CriteriaMapping {
  id              String    @id @default(uuid())
  criterionId     String
  evidenceId      String?
  institutionId   String
  standardId      String
  status          String    @default("gap")
  confidenceScore Float     @default(0.0)
  aiReasoning     String    @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  criterion   Criterion  @relation(fields: [criterionId], references: [id], onDelete: Cascade)
  evidence    Evidence?  @relation(fields: [evidenceId], references: [id], onDelete: SetNull)

  @@unique([criterionId, institutionId])
  @@index([standardId, institutionId])
  @@index([evidenceId])
}

// Chat Persistence Models
model Chat {
  id        String    @id @default(uuid())
  userId    String
  title     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  messages  Message[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}



model Message {
  id        String   @id @default(uuid())
  chatId    String
  userId    String
  role      String   // user, assistant, system
  content   String   @db.Text
  timestamp DateTime @default(now())
  
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
}

// Activity Feed Model
model Activity {
  id          String   @id @default(uuid())
  userId      String
  type        String   // evidence_uploaded, analysis_finished, score_updated, etc.
  title       String
  description String?  @db.Text
  entityId    String?  // Reference to related object (evidenceId, chatId, etc.)
  entityType  String?
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
}

// Notification System
model Notification {
  id              String   @id @default(uuid())
  userId          String
  type            String   // info, success, warning, error
  title           String
  message         String   @db.Text
  relatedEntityId String?
  relatedEntityType String? // evidence, gap, report, workflow
  isRead          Boolean  @default(false)
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt(sort: Desc)])
}

// Gap Analysis Model
model GapAnalysis {
  id                  String   @id @default(uuid())
  institutionId       String
  standardId          String?
  overallScore        Float
  summary             String   @db.Text
  gapsJson            String   @db.Text
  recommendationsJson String   @db.Text
  status              String   @default("pending")
  archived            Boolean  @default(false)
  createdAt           DateTime @default(now())

  institution  Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  standard     Standard?   @relation(fields: [standardId], references: [id], onDelete: SetNull)

  @@index([institutionId])
  @@index([standardId])
  @@index([archived])
}

// ═══════════════════════════════════════════════════════════════════════════
// PLATFORM STATE MODELS (Transitioning to Activity/Notification system)
// ═══════════════════════════════════════════════════════════════════════════

model PlatformFile {
  id          String   @id
  name        String
  type        String
  size        Int
  userId      String
  
  // Analysis results
  detectedStandards String[] @default([])
  documentType String?
  clauses     String[] @default([])
  analysisConfidence Float @default(0)
  
  // State
  status      String   @default("uploaded")
  
  // Cross-module links (Relations)
  evidence    PlatformEvidence[] @relation("FileEvidence")
  gaps        PlatformGap[]      @relation("FileGaps")
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
}

model PlatformEvidence {
  id          String   @id
  title       String
  type        String
  userId      String
  
  // State
  status      String   @default("defined")
  
  // References
  files       PlatformFile[]     @relation("FileEvidence")
  gaps        PlatformGap[]      @relation("GapEvidence")
  criteriaRefs Json @default("[]")
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
}

model PlatformGap {
  id          String   @id
  standard    String
  clause      String
  description String
  severity    String   @default("medium")
  userId      String
  
  // State
  status      String   @default("defined")
  
  // References
  evidence    PlatformEvidence[] @relation("GapEvidence")
  files       PlatformFile[]     @relation("FileGaps")
  
  // Metadata
  createdAt   DateTime @default(now())
  closedAt    DateTime?
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([standard])
}

model PlatformMetric {
  id          String   @id
  name        String
  value       Float
  previousValue Float?
  sourceModule String
  userId      String
  
  updatedAt   DateTime @updatedAt
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([sourceModule])
}

model PlatformEvent {
  id          String   @id @default(uuid())
  type        String
  userId      String
  entityId    String?
  metadata    Json     @default("{}")
  timestamp   DateTime @default(now())
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([type])
  @@index([timestamp])
}

// ═══════════════════════════════════════════════════════════════════════════
// AI RAG MODELS
// ═══════════════════════════════════════════════════════════════════════════

model VectorDocument {
  id             String                   @id @default(uuid())
  content        String                   @db.Text
  embedding      Unsupported("vector(768)")?
  
  // Metadata for filtering
  documentId     String? // References Evidence PDF id
  standardId     String? // References a specific standard
  chunkIndex     Int?    @default(0)
  
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  @@index([documentId])
  @@index([standardId])
}

// ═══════════════════════════════════════════════════════════════════════════
// HORUS VIRTUAL AUDITOR & AUTO-REMEDIATION MODELS
// ═══════════════════════════════════════════════════════════════════════════

model MockAuditSession {
  id            String   @id @default(uuid())
  institutionId String
  userId        String
  standardId    String?
  status        String   @default("active") // active, completed
  score         Float?   // Optional evaluation score at the end
  summary       String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  standard      Standard?   @relation(fields: [standardId], references: [id], onDelete: SetNull)
  messages      MockAuditMessage[]

  @@index([institutionId])
  @@index([userId])
  @@index([standardId])
}

model MockAuditMessage {
  id          String   @id @default(uuid())
  sessionId   String
  role        String   // user (staff), assistant (Horus AI), system
  content     String   @db.Text
  confidence  Float?   // AI's confidence in the user's answer
  createdAt   DateTime @default(now())

  session     MockAuditSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model DocumentDraft {
  id            String   @id @default(uuid())
  institutionId String
  userId        String
  gapId         String?  // The PlatformGap that triggered this draft
  title         String
  content       String   @db.Text // The markdown or HTML drafted by AI
  status        String   @default("draft") // draft, reviewed, finalized
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  
  // NOTE: PlatformGap goes not have a Prisma relation directly to avoid 
  // complex circular dependencies with the transitional PlatformState models,
  // so gapId is just a String reference.

  @@index([institutionId])
  @@index([userId])
  @@index([gapId])
}

