// Prisma Schema for Ayn Platform
generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User Model
model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  password      String
  role          Role     @default(TEACHER)
  institutionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  assessments   Assessment[]
  evidence      Evidence[] @relation("EvidenceUploader")
  notifications Notification[]

  @@index([email])
  @@index([institutionId])
}

enum Role {
  ADMIN
  TEACHER
  AUDITOR
}

// Institution Model
model Institution {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users                 User[]
  assessments           Assessment[]
  institutionStandards  InstitutionStandard[]
  gapAnalyses           GapAnalysis[]

  @@index([name])
}

// Institutionâ€“Standard link (many-to-many)
model InstitutionStandard {
  id            String   @id @default(uuid())
  institutionId String
  standardId    String
  createdAt     DateTime @default(now())

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  standard    Standard   @relation(fields: [standardId], references: [id], onDelete: Cascade)

  @@unique([institutionId, standardId])
  @@index([institutionId])
  @@index([standardId])
}

// Standard Model
model Standard {
  id          String   @id @default(uuid())
  title       String
  description String?

  criteria     Criterion[]
  assessments  Assessment[]
  institutionStandards InstitutionStandard[]
  gapAnalyses  GapAnalysis[]

  @@index([title])
}

// Criterion Model
model Criterion {
  id          String   @id @default(uuid())
  standardId  String
  title       String
  description String?

  standard    Standard @relation(fields: [standardId], references: [id], onDelete: Cascade)
  answers     AssessmentAnswer[]
  evidence    Evidence[]

  @@index([standardId])
}

// Assessment Model
model Assessment {
  id              String            @id @default(uuid())
  institutionId  String
  userId         String
  standardId     String?
  status         AssessmentStatus   @default(DRAFT)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  submittedAt    DateTime?
  reviewedAt     DateTime?
  reviewerComment String?

  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  standard      Standard? @relation(fields: [standardId], references: [id], onDelete: SetNull)
  answers       AssessmentAnswer[]

  @@index([institutionId])
  @@index([userId])
  @@index([standardId])
  @@index([status])
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  REVIEWED
}

// AssessmentAnswer Model
model AssessmentAnswer {
  id              String   @id @default(uuid())
  assessmentId    String
  criterionId     String
  answer          String?
  reviewerComment String?

  assessment      Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  criterion       Criterion @relation(fields: [criterionId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, criterionId])
  @@index([assessmentId])
  @@index([criterionId])
}

// Evidence Model
model Evidence {
  id          String   @id @default(uuid())
  criterionId String?
  fileUrl     String
  uploadedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  criterion   Criterion? @relation(fields: [criterionId], references: [id], onDelete: SetNull)
  uploadedBy  User @relation("EvidenceUploader", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([criterionId])
  @@index([uploadedById])
}

// Gap Analysis Model
model GapAnalysis {
  id                  String   @id @default(uuid())
  institutionId       String
  standardId          String
  assessmentId        String?
  overallScore        Float
  summary             String   @db.Text
  gapsJson            String   @db.Text
  recommendationsJson String   @db.Text
  archived            Boolean  @default(false)
  createdAt           DateTime @default(now())

  institution  Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  standard     Standard    @relation(fields: [standardId], references: [id], onDelete: SetNull)

  @@index([institutionId])
  @@index([standardId])
  @@index([archived])
}

// Notification Model
model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  body      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}
