// Prisma Schema for Ayn Platform
generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User Model
model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  password      String
  role          Role     @default(TEACHER)
  institutionId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  assessments   Assessment[]
  evidence      Evidence[] @relation("EvidenceUploader")
  notifications Notification[]

  // Platform State Relations
  platformFiles    PlatformFile[]
  platformEvidence PlatformEvidence[]
  platformGaps     PlatformGap[]
  platformMetrics  PlatformMetric[]
  platformEvents   PlatformEvent[]

  @@index([email])
  @@index([institutionId])
}

enum Role {
  ADMIN
  TEACHER
  AUDITOR
}

// Institution Model
model Institution {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users                 User[]
  assessments           Assessment[]
  institutionStandards  InstitutionStandard[]
  gapAnalyses           GapAnalysis[]

  @@index([name])
}

// Institution–Standard link (many-to-many)
model InstitutionStandard {
  id            String   @id @default(uuid())
  institutionId String
  standardId    String
  createdAt     DateTime @default(now())

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  standard    Standard   @relation(fields: [standardId], references: [id], onDelete: Cascade)

  @@unique([institutionId, standardId])
  @@index([institutionId])
  @@index([standardId])
}

// Standard Model
model Standard {
  id          String   @id @default(uuid())
  title       String
  description String?

  criteria     Criterion[]
  assessments  Assessment[]
  institutionStandards InstitutionStandard[]
  gapAnalyses  GapAnalysis[]

  @@index([title])
}

// Criterion Model
model Criterion {
  id          String   @id @default(uuid())
  standardId  String
  title       String
  description String?

  standard    Standard @relation(fields: [standardId], references: [id], onDelete: Cascade)
  answers     AssessmentAnswer[]
  evidence    Evidence[]

  @@index([standardId])
}

// Assessment Model
model Assessment {
  id              String            @id @default(uuid())
  institutionId  String
  userId         String
  standardId     String?
  status         AssessmentStatus   @default(DRAFT)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  submittedAt    DateTime?
  reviewedAt     DateTime?
  reviewerComment String?

  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  standard      Standard? @relation(fields: [standardId], references: [id], onDelete: SetNull)
  answers       AssessmentAnswer[]

  @@index([institutionId])
  @@index([userId])
  @@index([standardId])
  @@index([status])
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  REVIEWED
}

// AssessmentAnswer Model
model AssessmentAnswer {
  id              String   @id @default(uuid())
  assessmentId    String
  criterionId     String
  answer          String?
  reviewerComment String?

  assessment      Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  criterion       Criterion @relation(fields: [criterionId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, criterionId])
  @@index([assessmentId])
  @@index([criterionId])
}

// Evidence Model
model Evidence {
  id          String   @id @default(uuid())
  criterionId String?
  fileUrl     String
  uploadedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  criterion   Criterion? @relation(fields: [criterionId], references: [id], onDelete: SetNull)
  uploadedBy  User @relation("EvidenceUploader", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([criterionId])
  @@index([uploadedById])
}

// Gap Analysis Model
model GapAnalysis {
  id                  String   @id @default(uuid())
  institutionId       String
  standardId          String?
  assessmentId        String?
  overallScore        Float
  summary             String   @db.Text
  gapsJson            String   @db.Text
  recommendationsJson String   @db.Text
  archived            Boolean  @default(false)
  createdAt           DateTime @default(now())

  institution  Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  standard     Standard?   @relation(fields: [standardId], references: [id], onDelete: SetNull)

  @@index([institutionId])
  @@index([standardId])
  @@index([archived])
}

// Notification Model
model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  body      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

// ═══════════════════════════════════════════════════════════════════════════
// PLATFORM STATE MODELS
// ═══════════════════════════════════════════════════════════════════════════

model PlatformFile {
  id          String   @id
  name        String
  type        String
  size        Int
  userId      String
  
  // Analysis results
  detectedStandards String[] @default([])
  documentType String?
  clauses     String[] @default([])
  analysisConfidence Float @default(0)
  
  // State
  status      String   @default("uploaded")
  
  // Cross-module links (stored as JSON)
  linkedEvidenceIds Json @default("[]")
  linkedGapIds  Json @default("[]")
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
}

model PlatformEvidence {
  id          String   @id
  title       String
  type        String
  userId      String
  
  // State
  status      String   @default("defined")
  
  // References
  sourceFileIds Json @default("[]")
  criteriaRefs Json @default("[]")
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
}

model PlatformGap {
  id          String   @id
  standard    String
  clause      String
  description String
  severity    String   @default("medium")
  userId      String
  
  // State
  status      String   @default("defined")
  
  // References
  evidenceIds Json @default("[]")
  relatedFileIds Json @default("[]")
  
  // Metadata
  createdAt   DateTime @default(now())
  closedAt    DateTime?
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
  @@index([standard])
}

model PlatformMetric {
  id          String   @id
  name        String
  value       Float
  previousValue Float?
  sourceModule String
  userId      String
  
  updatedAt   DateTime @updatedAt
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([sourceModule])
}

model PlatformEvent {
  id          String   @id @default(uuid())
  type        String
  userId      String
  entityId    String?
  metadata    Json     @default("{}")
  timestamp   DateTime @default(now())
  
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([type])
  @@index([timestamp])
}
